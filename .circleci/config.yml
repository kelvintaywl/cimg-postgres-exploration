version: 2.1

jobs:
  xml-function:
    parameters:
      image:
        type: string
        default: postgres:9.6
        description: Docker image:tag for Postgres DB
    docker:
      - image: jbergknoff/postgresql-client
      - image: << parameters.image >>
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: Super5ecret
          POSTGRES_DB: exploration
    steps:
      - checkout
      - run:
          name: set up credentials
          command: |
            cp .pgpass ${HOME}/.pgpass
            chmod 0600 ${HOME}/.pgpass
            sleep 5s
      - run:
          name: Check `xmlcomment` function
          command: |
            psql -v ON_ERROR_STOP=1 -U postgres -d exploration -h localhost -p 5432 -c "SELECT xmlcomment('hello');"
      - run:
          name: Check `xmlconcat` function
          command: |
            psql -v ON_ERROR_STOP=1 -U postgres -d exploration -h localhost -p 5432 -c "SELECT xmlconcat('<abc/>', '<bar>foo</bar>');"
      - run:
          name: Check `xmlelement` function
          command: |
            psql -v ON_ERROR_STOP=1 -U postgres -d exploration -h localhost -p 5432 -c "SELECT xmlelement(name foo, xmlattributes('xyz' as bar));"
      - run:
          name: Check `xml_is_well_formed` function
          command: |
            psql -v ON_ERROR_STOP=1 -U postgres -d exploration -h localhost -p 5432 -c "SET xmloption TO DOCUMENT; SELECT xml_is_well_formed('<abc/>');"

workflows:
  main:
    jobs:
      - xml-function:
          name: cimg-postgres-13-4
          image: 'cimg/postgres:13.4'
      - xml-function:
          name: cimg-postgres-14-0
          image: 'cimg/postgres:14.0'
      - xml-function:
          name: cimg-postgres-13-4
          image: 'cimg/postgres:13.4-postgis'
      - xml-function:
          name: cimg-postgres-14-0
          image: 'cimg/postgres:14.0-postgis'
